name: Backend CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # JOB 1: BUILD AND PUSH
  # This job compiles the code, builds Docker images, and sends them to Docker Hub.
  build-and-push-backend:
    runs-on: ubuntu-latest
    steps:
    # 1. Checkout the source code from GitHub
    - uses: actions/checkout@v3

    # 2. Setup Java Environment (JDK 17) for building with Maven
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    # 3. Build the JAR files
    # 'clean package' removes old builds and creates new JARs.
    # '-DskipTests' avoids running tests to speed up the build (optional but common in fast CI).
    - name: Build Backend Services
      run: mvn clean package -DskipTests

    # 4. Setup Docker Buildx (Required for advanced Docker builds)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # 5. Login to Docker Hub
    # Uses secrets stored in GitHub Settings -> Secrets and Variables -> Actions
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 6. Build and Push Individual Service Images
    # Each service has its own "Build and Push" step.
    # It uses the PRE-BUILT JAR from step 3 (copied via Dockerfile).
    
    # Discovery Service (Eureka)
    - name: Build and Push Discovery Service
      uses: docker/build-push-action@v4
      with:
        context: ./discovery-service
        push: true
        tags: parthibanktech3/discovery-service:latest

    # API Gateway (Spring Cloud Gateway)
    - name: Build and Push API Gateway
      uses: docker/build-push-action@v4
      with:
        context: ./api-gateway
        push: true
        tags: parthibanktech3/api-gateway:latest

    # Student Service
    - name: Build and Push Student Service
      uses: docker/build-push-action@v4
      with:
        context: ./student-service
        push: true
        tags: parthibanktech3/student-service:latest

    # Course Service
    - name: Build and Push Course Service
      uses: docker/build-push-action@v4
      with:
        context: ./course-service
        push: true
        tags: parthibanktech3/course-service:latest

    # Enrollment Service
    - name: Build and Push Enrollment Service
      uses: docker/build-push-action@v4
      with:
        context: ./enrollment-service
        push: true
        tags: parthibanktech3/enrollment-service:latest

    # Payment Service
    - name: Build and Push Payment Service
      uses: docker/build-push-action@v4
      with:
        context: ./payment-service
        push: true
        tags: parthibanktech3/payment-service:latest

    # Notification Service
    - name: Build and Push Notification Service
      uses: docker/build-push-action@v4
      with:
        context: ./notification-service
        push: true
        tags: parthibanktech3/notification-service:latest

    # Infrastructure Service
    - name: Build and Push Infrastructure Service
      uses: docker/build-push-action@v4
      with:
        context: ./infrastructure-service
        push: true
        tags: parthibanktech3/infrastructure-service:latest

    # Library Service
    - name: Build and Push Library Service
      uses: docker/build-push-action@v4
      with:
        context: ./library-service
        push: true
        tags: parthibanktech3/library-service:latest

  # JOB 2: DEPLOY TO EC2
  # This job runs AFTER 'build-and-push-backend' succeeds.
  deploy-to-ec2:
    needs: build-and-push-backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 0. Clean up Disk Space (Prevent 100% usage error)
      - name: Clean up EC2 Disk Space
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "Cleaning up Docker disk space..."
            docker system prune -a -f || true
            docker volume prune -f || true

      # 0.1 Setup Swap Space (Critical for Low RAM EC2)
      - name: Setup Swap Space
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            if [ ! -f /swapfile ]; then
              echo "Creating 4GB swapfile..."
              sudo fallocate -l 4G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
            else
              echo "Swapfile already exists."
            fi
            free -h

      # 1. Copy Configuration Files to EC2
      # Uses SCP (Secure Copy) to transfer docker-compose.yml and nginx.conf
      - name: Copy docker-compose to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "docker-compose.yml,nginx.conf,init-databases.sql"
          target: "/home/${{ secrets.EC2_USER }}/student-management-system"
          strip_components: 0

      # 2. Execute Deployment Commands on EC2 via SSH
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/${{ secrets.EC2_USER }}/student-management-system
            
            # Application Secrets (Injected from GitHub Secrets)
            echo "MAIL_HOST=${{ secrets.MAIL_HOST }}" > .env
            echo "MAIL_PORT=${{ secrets.MAIL_PORT }}" >> .env
            echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
            echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env
            echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> .env
            
            echo "Deployment started..."
            
            # Step A: Stop and remove old containers to ensure clean state
            # Step A: Stop and remove old containers AND VOLUMES (Reset DB)
            docker-compose down -v || true
            
            # Step B: Login to Docker Hub (Fix Rate Limit)
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # Step C: Pull the Latest Images from Docker Hub
            docker-compose pull
            
            # Step C: Start Services in Detached Mode (-d)
            # --remove-orphans cleans up any containers not defined in the compose file
            docker-compose up -d --remove-orphans
            
            echo "Deployment successful! Services are starting up."
