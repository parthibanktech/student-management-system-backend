# =========================================================================================
# NGINX CONFIGURATION - REVERSE PROXY & LOAD BALANCER
# =========================================================================================
# This file configures the main entry point for the application.
# It handles routing traffic between the user (Frontend) and the backend microservices (API Gateway).

events {
    # worker_connections: Sets the maximum number of simultaneous connections that can be opened by a worker process.
    # Increasing this allows more concurrent users, but requires more system resources.
    worker_connections 1024;
}

http {
    # =====================================================================================
    # UPSTREAM DEFINITIONS
    # =====================================================================================
    # These blocks define the backend service groups. Docker's internal DNS resolves
    # 'frontend' and 'api-gateway' to their respective container IP addresses.

    # 1. Frontend Upstream
    #    Points to the 'frontend' container running the Angular app (Nginx serving static files).
    upstream frontend {
        server frontend:80;
    }

    # 2. API Gateway Upstream
    #    Points to the 'api-gateway' container (Spring Cloud Gateway) running on port 4000.
    upstream api_gateway {
        server api-gateway:4000;
    }

    # =====================================================================================
    # SERVER BLOCK
    # =====================================================================================
    server {
        # Listen on port 80 (Standard HTTP port)
        listen 80;
        server_name localhost;

        # ---------------------------------------------------------------------------------
        # ROUTE 1: Frontend Application (Root /)
        # ---------------------------------------------------------------------------------
        # Any request not matching /api will be sent to the Frontend container.
        location / {
            proxy_pass http://frontend;

            # Forwarding headers to ensure the backend sees the original client details
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------------------------------------------------------------------------------
        # ROUTE 2: API Requests (/api)
        # ---------------------------------------------------------------------------------
        # Requests starting with /api are forwarded to the internal API Gateway.
        # The Gateway then routes them to Student, Course, Enrollment, etc.
        location /api {
            proxy_pass http://api_gateway;
            
            # Standard Proxy Headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts (Optional tuning for long-running requests)
            proxy_read_timeout 60s;
            proxy_connect_timeout 60s;
        }
    }
}
